/*!
 * vuexfire v3.0.0-alpha.14
 * (c) 2018 Eduardo San Martin Morote
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Vuexfire={})}(this,function(e){"use strict";var t,i="vuexfire/SET_VALUE",u="vuexfire/ARRAY_ADD",c="vuexfire/ARRAY_REMOVE";function A(e){return Object.defineProperty(e.data(),"id",{value:e.id})}function h(a,i,u,e){void 0===i&&(i={}),void 0===u&&(u=""),void 0===e&&(e=[{},{}]),i=i||{};var t=Object.getOwnPropertyDescriptor(a,"id");return t&&!t.enumerable&&Object.defineProperty(e[0],"id",t),Object.keys(a).reduce(function(e,t){var n,r,o=a[t];return(r=o)&&r.onSnapshot?(e[0][t]=i[t]||o.path,e[1][u+t]=o):Array.isArray(o)?(e[0][t]=Array(o.length).fill(null),h(o,i[t],u+t+".",[e[0][t],e[1]])):null==o||o instanceof Date||o.toDate||o.longitude&&o.latitude?e[0][t]=o:(n=o)&&"object"==typeof n?(e[0][t]={},h(o,i[t],u+t+".",[e[0][t],e[1]])):e[0][t]=o,e},e)}function D(e){for(var t in e)e[t].unsub()}function b(e,v){var h=e.subs,b=e.refs,m=e.target,g=e.path,y=(e.data,e.depth),x=e.ops,j=e.resolve,t=Object.keys(b);if(Object.keys(h).filter(function(e){return t.indexOf(e)<0}).forEach(function(e){h[e].unsub(),delete h[e]}),!t.length||++y>v.maxRefDepth)return j(g);var O=0,k=t.length,R=Object.create(null);t.forEach(function(e){var t,n,r,o,a,i,u,c,s,f,d=h[e],p=b[e],l=g+"."+e;if(R[l]=!0,d){if(d.path===p.path)return;d.unsub()}h[e]={unsub:(t={ref:p,target:m,path:l,depth:y,ops:x,resolve:function(e){e in R&&++O>=k&&j(g)}.bind(null,l)},n=v,r=t.ref,o=t.target,a=t.path,i=t.depth,u=t.resolve,c=t.ops,s=Object.create(null),f=r.onSnapshot(function(e){e.exists?E({snapshot:A(e),target:o,path:a,ops:c,subs:s,depth:i,resolve:u},n):(c.set(o,a,null),u(a))}),function(){f(),D(s)}),path:p.path}})}function E(e,t){var n=e.snapshot,r=e.target,o=e.path,a=e.subs,i=e.ops,u=e.depth;void 0===u&&(u=0);var c=e.resolve;void 0===t&&(t={maxRefDepth:2});var s,f=h(n,(s=r,o.split(".").reduce(function(e,t){return e[t]},s))),d=f[0],p=f[1];i.set(r,o,d),b({data:d,subs:a,refs:p,target:r,path:o,ops:i,depth:u,resolve:c},t)}var r=((t={})[i]=function(e,t){var n,r,o,a,i,u=t.path,c=t.target,s=t.data;n=c,r=s,o=(""+u).split("."),a=o.pop(),(i=o.reduce(function(e,t){return e[t]},n)).splice?i.splice(a,1,r):i[a]=r},t[u]=function(e,t){var n=t.newIndex,r=t.data;t.target.splice(n,0,r)},t[c]=function(e,t){var n=t.oldIndex;return t.target.splice(n,1)[0]},t),o={},s={root:!0};Object.keys(r).forEach(function(n){o[n]=function(e,t){r[n](t.state,t)}});var f=new WeakMap;function d(e,n){var r=e.state,t=e.commit,o=e.key,a=e.ref,i=e.ops;void 0===n&&(n={maxRefDepth:2});var u=f.get(t);return u||(u=Object.create(null),f.set(t,u)),o in u&&p({commit:t,key:o}),new Promise(function(e,t){u[o]=a.where?function(e,s){var a=e.vm,i=e.key,t=e.collection,f=e.ops,d=e.resolve,n=e.reject;void 0===s&&(s={maxRefDepth:2});var u,p=f.set(a,i,[]),c=d,l=[],v={added:function(e){var t=e.newIndex,n=e.doc;l.splice(t,0,Object.create(null));var r=l[t],o=h(A(n)),a=o[0],i=o[1];f.add(p,t,a),b({data:a,refs:i,subs:r,target:p,path:t,depth:0,ops:f,resolve:d.bind(null,n)},s)},modified:function(e){var t=e.oldIndex,n=e.newIndex,r=e.doc,o=l.splice(t,1)[0];l.splice(n,0,o);var a=f.remove(p,t)[0],i=h(A(r),a),u=i[0],c=i[1];f.add(p,n,u),b({data:u,refs:c,subs:o,ops:f,target:p,path:n,depth:0,resolve:d},s)},removed:function(e){var t=e.oldIndex;f.remove(p,t),D(l.splice(t,1)[0])}},r=t.onSnapshot(function(e){var t="function"==typeof e.docChanges?e.docChanges():e.docChanges;if(!u&&t.length){u=!0;var n=0,r=t.length,o=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));d=function(e){e.id in o&&++n>=r&&(c(a[i]),d=function(e){})}}t.forEach(function(e){v[e.type](e)}),t.length||d()},n);return function(){r(),l.forEach(D)}}({vm:r,key:o,collection:a,ops:i,resolve:e,reject:t},n):function(e,t){var n,r,o,a=e.vm,i=e.key,u=e.document,c=e.resolve,s=e.reject,f=e.ops,d=Object.create(null);n=c,r=function(){return a[i]},c=function(){if(!o)return o=!0,n(r())};var p=u.onSnapshot(function(e){e.exists?E({snapshot:A(e),target:a,path:i,subs:d,ops:f,resolve:c},t):c()},s);return function(){p(),D(d)}}({vm:r,key:o,document:a,ops:i,resolve:e,reject:t},n)})}function p(e){var t=e.commit,n=e.key,r=f.get(t);r&&(r[n](),delete r[n])}e.firebaseMutations=o,e.firebaseAction=function(n){return function(e,t){var r=e.state,o=e.commit,a={set:function(e,t,n){return o(i,{path:t,target:e,data:n},s),n},add:function(e,t,n){return o(u,{target:e,newIndex:t,data:n},s)},remove:function(e,t){var n=e[t];return o(c,{target:e,oldIndex:t},s),[n]}};return e.bindFirebaseRef=function(e,t,n){return void 0===n&&(n={}),d({state:r,commit:o,key:e,ref:t,ops:a},n)},e.unbindFirebaseRef=function(e){return p({commit:o,key:e})},n(e,t)}},Object.defineProperty(e,"__esModule",{value:!0})});